<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Perfis e Papéis - Cockpit SAP Basis</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <nav class="sidebar">
      <h2>Cockpit SAP Basis</h2>
      <ul>
        <li><a href="/">Dashboard</a></li>
        <li><a href="/analytics.html">Analytics</a></li>
        <li><a href="/users.html">Gestão de Usuários</a></li>
        <li><a href="/profiles.html" class="active">Perfis e Papéis</a></li>
        <li><a href="/audit.html">Log de Auditoria</a></li>
        <li><a href="/metrics.html">Métricas</a></li>
      </ul>
    </nav>
    <div class="main-content">
      <header>
        <h1>Gestão de Perfis e Papéis</h1>
      </header>
      <main>
        <!-- Profile Management -->
        <section>
          <h2>Gestão de Perfis</h2>
          <form id="profile-form">
            <input name="profileName" placeholder="Nome do Perfil" required />
            <input name="description" placeholder="Descrição" />
            <select name="category">
              <option value="functional">Funcional</option>
              <option value="technical">Técnico</option>
              <option value="administrative">Administrativo</option>
            </select>
            <button type="submit">Criar Perfil</button>
          </form>
          <table id="profiles-table">
            <thead>
              <tr><th>Nome</th><th>Descrição</th><th>Categoria</th><th>Usuários</th><th>Ações</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- Role Management -->
        <section>
          <h2>Gestão de Papéis</h2>
          <form id="role-form">
            <input name="roleName" placeholder="Nome do Papel" required />
            <input name="description" placeholder="Descrição" />
            <select name="type">
              <option value="authorization">Autorização</option>
              <option value="business">Negócio</option>
              <option value="system">Sistema</option>
            </select>
            <button type="submit">Criar Papel</button>
          </form>
          <table id="roles-table">
            <thead>
              <tr><th>Nome</th><th>Descrição</th><th>Tipo</th><th>Usuários</th><th>Ações</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- User Assignment -->
        <section>
          <h2>Atribuição de Perfis e Papéis</h2>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
            <div>
              <h3>Atribuir Perfil</h3>
              <form id="assign-profile-form">
                <select id="user-select-profile" required>
                  <option value="">Selecione o usuário</option>
                </select>
                <select id="profile-select" required>
                  <option value="">Selecione o perfil</option>
                </select>
                <button type="submit">Atribuir Perfil</button>
              </form>
            </div>
            <div>
              <h3>Atribuir Papel</h3>
              <form id="assign-role-form">
                <select id="user-select-role" required>
                  <option value="">Selecione o usuário</option>
                </select>
                <select id="role-select" required>
                  <option value="">Selecione o papel</option>
                </select>
                <button type="submit">Atribuir Papel</button>
              </form>
            </div>
          </div>
        </section>

        <!-- Current Assignments -->
        <section>
          <h2>Atribuições Atuais</h2>
          <div id="assignments-container">
            <p>Selecione um usuário para ver suas atribuições</p>
          </div>
        </section>
      </main>
    </div>
    <script>
      let profiles = [];
      let roles = [];
      let users = [];

      // Helper functions
      async function api(path, options = {}) {
        const res = await fetch(path, { 
          headers: { 'Content-Type': 'application/json' }, 
          ...options 
        });
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }

      // Load data
      async function loadData() {
        try {
          users = await api('/api/users');
          loadProfiles();
          loadRoles();
          populateUserSelects();
        } catch (error) {
          console.error('Erro ao carregar dados:', error);
        }
      }

      // Profile Management
      async function loadProfiles() {
        // Mock data for profiles
        profiles = [
          { id: '1', profileName: 'SAP_ALL', description: 'Acesso total ao sistema', category: 'administrative', userCount: 5 },
          { id: '2', profileName: 'SAP_DEVELOPER', description: 'Perfil para desenvolvedores', category: 'technical', userCount: 12 },
          { id: '3', profileName: 'SAP_USER', description: 'Usuário padrão', category: 'functional', userCount: 150 }
        ];
        
        const tbody = document.querySelector('#profiles-table tbody');
        tbody.innerHTML = profiles.map(p => `<tr>
          <td>${p.profileName}</td>
          <td>${p.description}</td>
          <td>${p.category}</td>
          <td>${p.userCount}</td>
          <td class="actions">
            <button onclick="editProfile('${p.id}')">Editar</button>
            <button onclick="deleteProfile('${p.id}')">Excluir</button>
          </td>
        </tr>`).join('');
      }

      document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = new FormData(e.target);
        const profile = Object.fromEntries(form);
        profile.id = Date.now().toString();
        profile.userCount = 0;
        profiles.push(profile);
        loadProfiles();
        populateProfileSelect();
        e.target.reset();
      });

      // Role Management
      async function loadRoles() {
        // Mock data for roles
        roles = [
          { id: '1', roleName: 'ADMIN_ROLE', description: 'Papel administrativo', type: 'authorization', userCount: 3 },
          { id: '2', roleName: 'DEVELOPER_ROLE', description: 'Papel de desenvolvedor', type: 'business', userCount: 8 },
          { id: '3', roleName: 'USER_ROLE', description: 'Papel de usuário', type: 'system', userCount: 200 }
        ];
        
        const tbody = document.querySelector('#roles-table tbody');
        tbody.innerHTML = roles.map(r => `<tr>
          <td>${r.roleName}</td>
          <td>${r.description}</td>
          <td>${r.type}</td>
          <td>${r.userCount}</td>
          <td class="actions">
            <button onclick="editRole('${r.id}')">Editar</button>
            <button onclick="deleteRole('${r.id}')">Excluir</button>
          </td>
        </tr>`).join('');
      }

      document.getElementById('role-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = new FormData(e.target);
        const role = Object.fromEntries(form);
        role.id = Date.now().toString();
        role.userCount = 0;
        roles.push(role);
        loadRoles();
        populateRoleSelect();
        e.target.reset();
      });

      // Populate selects
      function populateUserSelects() {
        const userSelects = ['user-select-profile', 'user-select-role'];
        userSelects.forEach(selectId => {
          const select = document.getElementById(selectId);
          select.innerHTML = '<option value="">Selecione o usuário</option>' +
            users.map(u => `<option value="${u.id}">${u.username} - ${u.fullName}</option>`).join('');
        });
      }

      function populateProfileSelect() {
        const select = document.getElementById('profile-select');
        select.innerHTML = '<option value="">Selecione o perfil</option>' +
          profiles.map(p => `<option value="${p.profileName}">${p.profileName}</option>`).join('');
      }

      function populateRoleSelect() {
        const select = document.getElementById('role-select');
        select.innerHTML = '<option value="">Selecione o papel</option>' +
          roles.map(r => `<option value="${r.roleName}">${r.roleName}</option>`).join('');
      }

      // Assignment forms
      document.getElementById('assign-profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const userId = document.getElementById('user-select-profile').value;
        const profileName = document.getElementById('profile-select').value;
        
        if (!userId || !profileName) return;
        
        try {
          await api(`/api/users/${userId}/profiles`, {
            method: 'POST',
            body: JSON.stringify({ profileName })
          });
          alert('Perfil atribuído com sucesso!');
          loadUserAssignments(userId);
        } catch (error) {
          alert('Erro ao atribuir perfil: ' + error.message);
        }
      });

      document.getElementById('assign-role-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const userId = document.getElementById('user-select-role').value;
        const roleName = document.getElementById('role-select').value;
        
        if (!userId || !roleName) return;
        
        try {
          await api(`/api/users/${userId}/roles`, {
            method: 'POST',
            body: JSON.stringify({ roleName })
          });
          alert('Papel atribuído com sucesso!');
          loadUserAssignments(userId);
        } catch (error) {
          alert('Erro ao atribuir papel: ' + error.message);
        }
      });

      // Load user assignments
      async function loadUserAssignments(userId) {
        try {
          const user = await api(`/api/users/${userId}`);
          const container = document.getElementById('assignments-container');
          container.innerHTML = `
            <h3>Atribuições de ${user.username}</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
              <div>
                <h4>Perfis (${user.profiles.length})</h4>
                <ul>${user.profiles.map(p => `<li>${p} <button onclick="removeProfile('${userId}', '${p}')">Remover</button></li>`).join('')}</ul>
              </div>
              <div>
                <h4>Papéis (${user.roles.length})</h4>
                <ul>${user.roles.map(r => `<li>${r} <button onclick="removeRole('${userId}', '${r}')">Remover</button></li>`).join('')}</ul>
              </div>
            </div>
          `;
        } catch (error) {
          console.error('Erro ao carregar atribuições:', error);
        }
      }

      // Event listeners for user selection
      document.getElementById('user-select-profile').addEventListener('change', (e) => {
        if (e.target.value) loadUserAssignments(e.target.value);
      });

      document.getElementById('user-select-role').addEventListener('change', (e) => {
        if (e.target.value) loadUserAssignments(e.target.value);
      });

      // Remove functions
      window.removeProfile = async (userId, profileName) => {
        if (confirm(`Remover perfil ${profileName}?`)) {
          try {
            await api(`/api/users/${userId}/profiles/${profileName}`, { method: 'DELETE' });
            loadUserAssignments(userId);
          } catch (error) {
            alert('Erro ao remover perfil: ' + error.message);
          }
        }
      };

      window.removeRole = async (userId, roleName) => {
        if (confirm(`Remover papel ${roleName}?`)) {
          try {
            await api(`/api/users/${userId}/roles/${roleName}`, { method: 'DELETE' });
            loadUserAssignments(userId);
          } catch (error) {
            alert('Erro ao remover papel: ' + error.message);
          }
        }
      };

      // Mock functions for profile/role management
      window.editProfile = (id) => {
        const profile = profiles.find(p => p.id === id);
        if (profile) {
          document.getElementById('profile-form').profileName.value = profile.profileName;
          document.getElementById('profile-form').description.value = profile.description;
          document.getElementById('profile-form').category.value = profile.category;
        }
      };

      window.deleteProfile = (id) => {
        if (confirm('Excluir este perfil?')) {
          profiles = profiles.filter(p => p.id !== id);
          loadProfiles();
          populateProfileSelect();
        }
      };

      window.editRole = (id) => {
        const role = roles.find(r => r.id === id);
        if (role) {
          document.getElementById('role-form').roleName.value = role.roleName;
          document.getElementById('role-form').description.value = role.description;
          document.getElementById('role-form').type.value = role.type;
        }
      };

      window.deleteRole = (id) => {
        if (confirm('Excluir este papel?')) {
          roles = roles.filter(r => r.id !== id);
          loadRoles();
          populateRoleSelect();
        }
      };

      // Initialize
      loadData();
    </script>
  </body>
</html>
