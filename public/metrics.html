<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Métricas - Cockpit SAP Basis</title>
    <link rel="stylesheet" href="/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <nav class="sidebar">
      <h2>Cockpit SAP Basis</h2>
      <ul>
        <li><a href="/">Dashboard</a></li>
        <li><a href="/analytics.html">Analytics</a></li>
        <li><a href="/users.html">Gestão de Usuários</a></li>
        <li><a href="/profiles.html">Gestão de Perfis</a></li>
        <li><a href="/roles.html">Gestão de Papéis</a></li>
        <li><a href="/assignments.html">Atribuições</a></li>
        <li><a href="/audit.html">Log de Auditoria</a></li>
        <li><a href="/metrics.html" class="active">Métricas</a></li>
      </ul>
    </nav>
    <div class="main-content">
      <header>
        <h1>Métricas do Sistema</h1>
        <nav>
          <button data-tab="overview" class="active">Visão Geral</button>
          <button data-tab="users">Usuários</button>
          <button data-tab="performance">Performance</button>
          <button data-tab="security">Segurança</button>
        </nav>
      </header>
      <main>
        <!-- Overview Tab -->
        <section id="overview" class="tab active card">
          <h2>Visão Geral do Sistema</h2>
          <div id="metrics-cards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">
            <!-- Cards will be populated by JavaScript -->
          </div>
        </section>

        <!-- Users Tab -->
        <section id="users" class="tab card">
          <h2>Métricas de Usuários</h2>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px">
            <div>
              <h3>Usuários por Status</h3>
              <canvas id="usersStatusChart" height="200"></canvas>
            </div>
            <div>
              <h3>Atribuições de Perfis e Papéis</h3>
              <canvas id="assignmentsChart" height="200"></canvas>
            </div>
          </div>
        </section>

        <!-- Performance Tab -->
        <section id="performance" class="tab card">
          <h2>Métricas de Performance</h2>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px">
            <div>
              <h3>Atividades de Usuário</h3>
              <canvas id="userActivitiesChart" height="200"></canvas>
            </div>
            <div>
              <h3>Logins por Período</h3>
              <canvas id="loginsChart" height="200"></canvas>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
            <div>
              <h3>Tempo de Resposta</h3>
              <canvas id="responseTimeChart" height="200"></canvas>
            </div>
            <div>
              <h3>Uso de Recursos</h3>
              <canvas id="performanceChart" height="200"></canvas>
            </div>
          </div>
        </section>

        <!-- Security Tab -->
        <section id="security" class="tab card">
          <h2>Métricas de Segurança</h2>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px">
            <div>
              <h3>Tipos de Erro</h3>
              <canvas id="errorsChart" height="200"></canvas>
            </div>
            <div>
              <h3>Tentativas de Login</h3>
              <canvas id="loginAttemptsChart" height="200"></canvas>
            </div>
          </div>
        </section>

      </main>
    </div>
    <script>
      let metrics = {};
      let charts = {};

      // Helper functions
      async function api(path, options = {}) {
        const res = await fetch(path, { 
          headers: { 'Content-Type': 'application/json' }, 
          ...options 
        });
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }

      // Load metrics data
      async function loadMetrics() {
        console.log('Carregando métricas...');
        
        // Use mock data for now to ensure it works
        metrics = {
          // Overview metrics
          totalUsers: 150,
          activeUsers: 120,
          blockedUsers: 30,
          totalProfiles: 25,
          totalRoles: 18,
          systemUptime: 99.8,
          responseTime: 120,
          
          // User metrics
          usersCreated: 25,
          usersModified: 45,
          usersDeleted: 5,
          loginsToday: 85,
          loginsThisWeek: 420,
          loginsThisMonth: 1800,
          avgSessionTime: 45,
          peakConcurrentUsers: 25,
          
          // Profile and role metrics
          profilesAssigned: 80,
          profilesRemoved: 15,
          rolesAssigned: 60,
          rolesRemoved: 10,
          profileChanges: 15,
          roleChanges: 12,
          
          // Performance metrics
          avgResponseTime: 120,
          maxResponseTime: 450,
          minResponseTime: 50,
          requestsPerSecond: 25,
          cpuUsage: 65,
          memoryUsage: 78,
          diskUsage: 45,
          
          // Security metrics
          securityAlerts: 3,
          failedLogins: 12,
          passwordChanges: 8,
          suspiciousActivities: 2,
          blockedIPs: 5,
          securityIncidents: 1,
          auditsCompleted: 200,
          
          // Activity data for charts
          userActivityData: {
            labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
            data: [5, 8, 25, 35, 28, 15]
          },
          loginData: {
            labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'],
            data: [45, 52, 38, 61, 55, 28, 35]
          },
          errorData: {
            labels: ['Erro 404', 'Erro 500', 'Timeout', 'Auth Failed', 'DB Error'],
            data: [12, 8, 5, 15, 3]
          },
          performanceData: {
            labels: ['CPU', 'RAM', 'Disk', 'Network'],
            data: [65, 78, 45, 32]
          }
        };
        
        console.log('Métricas carregadas:', metrics);
        renderMetricsCards();
        createCharts();
      }

      // Render metrics cards
      function renderMetricsCards() {
        console.log('Renderizando cards de métricas...', metrics);
        const container = document.getElementById('metrics-cards');
        if (!container) {
          console.error('Container metrics-cards não encontrado!');
          return;
        }
        
        const cards = [
          { title: 'Total de Usuários', value: metrics.totalUsers, color: '#007bff' },
          { title: 'Usuários Ativos', value: metrics.activeUsers, color: '#28a745' },
          { title: 'Sistema Online', value: `${metrics.systemUptime}%`, color: '#20c997' },
          { title: 'Logins Hoje', value: metrics.loginsToday, color: '#17a2b8' },
          { title: 'Perfis Totais', value: metrics.totalProfiles, color: '#ffc107' },
          { title: 'Papéis Totais', value: metrics.totalRoles, color: '#6f42c1' },
          { title: 'Tempo Resposta', value: `${metrics.responseTime}ms`, color: '#fd7e14' },
          { title: 'Alertas Segurança', value: metrics.securityAlerts, color: '#dc3545' }
        ];

        container.innerHTML = cards.map(card => `
          <div style="background:${card.color};color:white;padding:16px;border-radius:8px;text-align:center">
            <h3 style="margin:0;font-size:24px">${card.value}</h3>
            <p style="margin:8px 0 0 0;font-size:14px">${card.title}</p>
          </div>
        `).join('');
        
        console.log('Cards renderizados com sucesso');
      }


      // Create charts
      function createCharts() {
        console.log('Criando gráficos...', metrics);
        
        // Users by Status (Users tab)
        const usersStatusCtx = document.getElementById('usersStatusChart');
        if (usersStatusCtx) {
          if (charts.usersStatus) charts.usersStatus.destroy();
          charts.usersStatus = new Chart(usersStatusCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: ['Ativos', 'Bloqueados'],
              datasets: [{
                data: [metrics.activeUsers, metrics.blockedUsers],
                backgroundColor: ['#28a745', '#dc3545']
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { labels: { font: { size: 14 } } }
              }
            }
          });
        }

        // Assignments (Users tab)
        const assignmentsCtx = document.getElementById('assignmentsChart');
        if (assignmentsCtx) {
          if (charts.assignments) charts.assignments.destroy();
          charts.assignments = new Chart(assignmentsCtx.getContext('2d'), {
            type: 'bar',
            data: {
              labels: ['Perfis Atribuídos', 'Perfis Removidos', 'Papéis Atribuídos', 'Papéis Removidos'],
              datasets: [{
                data: [metrics.profilesAssigned, metrics.profilesRemoved, metrics.rolesAssigned, metrics.rolesRemoved],
                backgroundColor: ['#007bff', '#dc3545', '#28a745', '#ffc107']
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false }
              }
            }
          });
        }

        // User Activities (Performance tab)
        const userActivitiesCtx = document.getElementById('userActivitiesChart');
        if (userActivitiesCtx) {
          if (charts.userActivities) charts.userActivities.destroy();
          charts.userActivities = new Chart(userActivitiesCtx.getContext('2d'), {
            type: 'line',
            data: {
              labels: metrics.userActivityData.labels,
              datasets: [{
                label: 'Usuários Ativos',
                data: metrics.userActivityData.data,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { labels: { font: { size: 14 } } }
              }
            }
          });
        }

        // Logins by Period (Performance tab)
        const loginsCtx = document.getElementById('loginsChart');
        if (loginsCtx) {
          if (charts.logins) charts.logins.destroy();
          charts.logins = new Chart(loginsCtx.getContext('2d'), {
            type: 'bar',
            data: {
              labels: metrics.loginData.labels,
              datasets: [{
                label: 'Logins',
                data: metrics.loginData.data,
                backgroundColor: '#28a745'
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { labels: { font: { size: 14 } } }
              }
            }
          });
        }

        // Response Time Chart (Performance tab)
        const responseTimeCtx = document.getElementById('responseTimeChart');
        if (responseTimeCtx) {
          if (charts.responseTime) charts.responseTime.destroy();
          charts.responseTime = new Chart(responseTimeCtx.getContext('2d'), {
            type: 'line',
            data: {
              labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
              datasets: [{
                label: 'Tempo de Resposta (ms)',
                data: [120, 95, 110, 150, 130, 100],
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { labels: { font: { size: 14 } } }
              }
            }
          });
        }

        // Error Types (Security tab)
        const errorsCtx = document.getElementById('errorsChart');
        if (errorsCtx) {
          if (charts.errors) charts.errors.destroy();
          charts.errors = new Chart(errorsCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: metrics.errorData.labels,
              datasets: [{
                data: metrics.errorData.data,
                backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#6f42c1', '#20c997']
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { labels: { font: { size: 14 } } }
              }
            }
          });
        }

        // Login Attempts (Security tab)
        const loginAttemptsCtx = document.getElementById('loginAttemptsChart');
        if (loginAttemptsCtx) {
          if (charts.loginAttempts) charts.loginAttempts.destroy();
          charts.loginAttempts = new Chart(loginAttemptsCtx.getContext('2d'), {
            type: 'bar',
            data: {
              labels: ['Sucesso', 'Falha', 'Bloqueado'],
              datasets: [{
                data: [metrics.loginsToday, metrics.failedLogins, metrics.blockedIPs],
                backgroundColor: ['#28a745', '#dc3545', '#ffc107']
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { labels: { font: { size: 14 } } }
              }
            }
          });
        }

        // Performance Chart (Performance tab)
        const performanceCtx = document.getElementById('performanceChart');
        if (performanceCtx) {
          if (charts.performance) charts.performance.destroy();
          charts.performance = new Chart(performanceCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: metrics.performanceData.labels,
              datasets: [{
                data: metrics.performanceData.data,
                backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#20c997']
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { labels: { font: { size: 14 } } }
              }
            }
          });
        }

        // User Activities (Performance tab) - already handled above

        // Logins (mock data) - already handled above
      }

      // Export functions
      function exportMetrics(format) {
        let content, filename, mimeType;
        
        if (format === 'json') {
          content = JSON.stringify(metrics, null, 2);
          filename = `metrics-${new Date().toISOString().slice(0,10)}.json`;
          mimeType = 'application/json';
        } else if (format === 'csv') {
          const headers = ['Métrica', 'Valor'];
          const rows = Object.entries(metrics).map(([key, value]) => [key, value]);
          content = [headers, ...rows].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
          filename = `metrics-${new Date().toISOString().slice(0,10)}.csv`;
          mimeType = 'text/csv';
        }

        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      // Generate PDF report (mock)
      function generateReport() {
        alert('Funcionalidade de geração de PDF será implementada em versão futura');
      }

      function toggleSubmenu(element) {
        const submenu = element.querySelector('.submenu');
        const isOpen = submenu.classList.contains('show');
        
        // Close all other submenus
        document.querySelectorAll('.submenu').forEach(sm => sm.classList.remove('show'));
        document.querySelectorAll('.has-submenu').forEach(li => li.classList.remove('open'));
        
        // Toggle current submenu
        if (!isOpen) {
          submenu.classList.add('show');
          element.classList.add('open');
        }
      }

      // Tab Management
      function initTabs() {
        const tabButtons = document.querySelectorAll('nav button[data-tab]');
        const tabSections = document.querySelectorAll('.tab');

        tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');
            
            // Remove active class from all buttons and sections
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabSections.forEach(section => section.classList.remove('active'));
            
            // Add active class to clicked button and corresponding section
            button.classList.add('active');
            document.getElementById(targetTab).classList.add('active');
          });
        });
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM carregado, iniciando métricas...');
        loadMetrics();
        initTabs();
      });
    </script>
  </body>
</html>

